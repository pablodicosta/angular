<!DOCTYPE html>
<html ng-app="routes">
<head>
	<title>Ejercicio 5</title>
	<script type="text/javascript" src="../angular.min.js"></script>
	<script type="text/javascript" src="../angular-route.min.js"></script>

	<script type="text/javascript">

		var app = angular.module('routes', ['ngRoute']);

		var route1Model = {	routeId: 1 },
			route2Model = { routeId: 2 },
			route3Model = { routeId: 3 };

		app.constant('AUTH_EVENTS', {
			loginSuccess: 'auth-login-success',
			loginFailed: 'auth-login-failed',
			logoutSuccess: 'auth-logout-success',
			sessionTimeout: 'auth-session-timeout',
			notAuthenticated: 'auth-not-authenticated',
			notAuthorized: 'auth-not-authorized'
		});

		app.constant('USER_ROLES', {
			all: '*',
			admin: 'admin',
			editor: 'editor',
			guest: 'guest'
		});

		app.service('userSession', function () {
			return {
				create: function (userId, userRole) {
					this.userId = userId;
					this.userRole = userRole;
				},
				destroy: function () {
					this.userId = null;
					this.userRole = null;
				}				
			}
		});

		app.service('loginService', function ($q, $http, userSession, USER_ROLES) {
			return {
				login: function (credentials) {
					var deferred = $q.defer();
					$http.post('/rest/login', credentials)
						.success(function (res) {
							if(res.logged) {
								userSession.create(credentials.user, USER_ROLES.all);
								console.log(userSession);
								deferred.resolve();								
							} else {
								deferred.reject(true);
							}
						})
						.error(function (res) {
							deferred.reject(false);
						});
					return deferred.promise;
				},
				logout: function () {
					userSession.destroy();
				},
				isAuthenticated: function () {
					return !!userSession.userId;
				}
			}
		});

		app.service('dateService', function ($q, $http) {
			return {
				getDate: function () {
					var deferred = $q.defer();
					$http.get('/rest/date')
						.success(function (data) {
							deferred.resolve(data);
						})
						.error(function () {
							deferred.reject();
						});
					return deferred.promise;
				}				
			}			
		});

		var getDate = function ($q, dateService) {
			var deferred = $q.defer();
			dateService.getDate()
				.then(function (data) {
					deferred.resolve(data);
				}, function () {
					deferred.reject();
				});
			return deferred.promise;
		}

		app.config(['$routeProvider', function ($routeProvider) {

			$routeProvider
				.when('/route1/:from?', {
					templateUrl: 'routeView.html',
					controller: 'routeCtrl',
					resolve: {
						model: function () { return route1Model; },
						dateInfo: getDate
					} 
				})
				.when('/route2/:from?', {
					templateUrl: 'routeView.html',
					controller: 'routeCtrl',
					resolve: { 
						model: function () { return route2Model; },
						dateInfo: getDate
					} 
				})
				.when('/route3/:from?', {
					templateUrl: 'routeView.html',
					controller: 'routeCtrl',
					resolve: { 
						model: function () { return route3Model; },
						dateInfo: getDate
					} 
				})
				.when('/login', {
					templateUrl: 'login.html',
					controller: 'loginCtrl'
				})
				.otherwise({
					redirectTo: '/route1'
				});
			
		}]);

		app.controller('loginCtrl', function ($scope, loginService, $location, userSession) {
			$scope.login = function (credentials) {
				loginService.login(credentials)
					.then(function () {
						$scope.logged = "Access granted!";
						$location.path('route1');
					}, function (res) {
						$scope.logged = res ? "Invalid password..." : "Login failed...";
					});
			};
		});

		app.controller('routeCtrl', function ($scope, $routeParams, model, dateInfo, userSession) {
			
			console.log(userSession.userId);

			$scope.currentId = model.routeId;
			$scope.from = $routeParams.from;
			$scope.date = dateInfo.currentDate;			
		});

		app.controller('mainCtrl', function ($scope, $rootScope, $location, loginService) {
			$rootScope.$on('$routeChangeError', function () {
				$scope.date = 'ERROR!';
			});
			
			$scope.template = { nav: "nav.html" };
			$scope.isAuthenticated = loginService.isAuthenticated;

			$scope.go = function (path) {
				var currentRoute = $location.path().split('/')[1];
				$location.path(path + '/' + currentRoute);
			};
		});

	</script>

</head>
<body ng-controller="mainCtrl">
	<div ng-if="isAuthenticated()" ng-include="template.nav"></div>
	<div ng-view></div>
</body>
</html>